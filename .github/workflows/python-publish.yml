name: Build and Publish Python Package

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      test_pypi:
        description: 'Publish to Test PyPI instead of PyPI'
        required: false
        type: boolean
        default: false

permissions:
  contents: read

jobs:
  linux:
    name: Build wheels on Linux
    runs-on: ubuntu-latest
    strategy:
      matrix:
        target: [x86_64, aarch64]
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: |
          3.8
          3.9
          3.10
          3.11
          3.12
    
    - name: Install maturin
      run: pip install maturin
    
    - name: Set up QEMU
      if: matrix.target == 'aarch64'
      uses: docker/setup-qemu-action@v3
      with:
        platforms: arm64
    
    - name: Build wheels
      run: |
        maturin build --release --features python --target ${{ matrix.target }}-unknown-linux-gnu --interpreter python3.8 python3.9 python3.10 python3.11 python3.12 --out dist
    
    - name: Upload wheels
      uses: actions/upload-artifact@v4
      with:
        name: wheels-linux-${{ matrix.target }}
        path: dist/*.whl

  windows:
    name: Build wheels on Windows
    runs-on: windows-latest
    strategy:
      matrix:
        target: [x64]
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python 3.8
      uses: actions/setup-python@v5
      with:
        python-version: '3.8'
        architecture: ${{ matrix.target }}
    
    - name: Set up Python 3.9
      uses: actions/setup-python@v5
      with:
        python-version: '3.9'
        architecture: ${{ matrix.target }}
    
    - name: Set up Python 3.10
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'
        architecture: ${{ matrix.target }}
    
    - name: Set up Python 3.11
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        architecture: ${{ matrix.target }}
    
    - name: Set up Python 3.12
      uses: actions/setup-python@v5
      with:
        python-version: '3.12'
        architecture: ${{ matrix.target }}
    
    - name: Install Rust
      uses: dtolnay/rust-toolchain@stable
      with:
        targets: ${{ matrix.target == 'x64' && 'x86_64-pc-windows-msvc' || 'i686-pc-windows-msvc' }}
    
    - name: Install maturin
      run: |
        python3.12 -m pip install maturin
    
    - name: Build wheels
      run: |
        python3.12 -m maturin build --release --features python --target ${{ matrix.target == 'x64' && 'x86_64-pc-windows-msvc' || 'i686-pc-windows-msvc' }} --interpreter python3.8 python3.9 python3.10 python3.11 python3.12 --out dist
    
    - name: Upload wheels
      uses: actions/upload-artifact@v4
      with:
        name: wheels-windows-${{ matrix.target }}
        path: dist/*.whl

  macos:
    name: Build wheels on macOS
    runs-on: macos-latest
    strategy:
      matrix:
        target: [x86_64, aarch64]
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: |
          3.8
          3.9
          3.10
          3.11
          3.12
    
    - name: Install Rust
      uses: dtolnay/rust-toolchain@stable
      with:
        targets: ${{ matrix.target }}-apple-darwin
    
    - name: Install maturin
      run: pip install maturin
    
    - name: Build wheels
      run: |
        maturin build --release --features python --target ${{ matrix.target }}-apple-darwin --interpreter python3.8 python3.9 python3.10 python3.11 python3.12 --out dist
    
    - name: Upload wheels
      uses: actions/upload-artifact@v4
      with:
        name: wheels-macos-${{ matrix.target }}
        path: dist/*.whl

  sdist:
    name: Build source distribution
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    
    - name: Install maturin
      run: pip install maturin
    
    - name: Build sdist
      run: maturin sdist --out dist
    
    - name: Upload sdist
      uses: actions/upload-artifact@v4
      with:
        name: sdist
        path: dist/*.tar.gz

  test-wheels:
    name: Test wheels
    needs: [linux, windows, macos]
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        python-version: ['3.8', '3.9', '3.10', '3.11', '3.12']
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ matrix.python-version }}
    
    - name: Download wheels
      uses: actions/download-artifact@v4
      with:
        pattern: wheels-*
        path: dist
        merge-multiple: true
    
    - name: Install wheel (Linux)
      if: runner.os == 'Linux'
      run: |
        pip install dist/*manylinux*x86_64*.whl
    
    - name: Install wheel (Windows)
      if: runner.os == 'Windows'
      run: |
        pip install (Get-ChildItem dist/*win_amd64*.whl | Select-Object -First 1).FullName
    
    - name: Install wheel (macOS)
      if: runner.os == 'macOS'
      run: |
        ARCH=$(uname -m)
        if [ "$ARCH" = "arm64" ]; then
          pip install dist/*macosx*arm64*.whl
        else
          pip install dist/*macosx*x86_64*.whl
        fi
    
    - name: Test import
      run: |
        python -c "import reg_parser; print(f'Successfully imported reg_parser version {reg_parser.__version__}')"
    
    - name: Run Python tests
      run: |
        pip install pytest
        pytest python/tests/ -v || echo "No tests found or tests failed"

  publish:
    name: Publish to PyPI
    needs: [linux, windows, macos, sdist, test-wheels]
    runs-on: ubuntu-latest
    environment:
      name: pypi
      url: https://pypi.org/p/reg-parser
    permissions:
      id-token: write
    
    steps:
    - name: Download all artifacts
      uses: actions/download-artifact@v4
      with:
        path: dist
    
    - name: Flatten artifacts
      run: |
        mkdir -p final-dist
        find dist -name '*.whl' -exec mv {} final-dist/ \;
        find dist -name '*.tar.gz' -exec mv {} final-dist/ \;
        ls -lh final-dist/
    
    - name: Publish to Test PyPI
      if: github.event.inputs.test_pypi == 'true'
      uses: pypa/gh-action-pypi-publish@release/v1
      with:
        repository-url: https://test.pypi.org/legacy/
        packages-dir: final-dist/
        skip-existing: true
    
    - name: Publish to PyPI
      if: github.event.inputs.test_pypi != 'true' && startsWith(github.ref, 'refs/tags/')
      uses: pypa/gh-action-pypi-publish@release/v1
      with:
        packages-dir: final-dist/
        skip-existing: true
